---
- name: Address object tasks
  block:
    - name: Address tag objects(s)
      paloaltonetworks.panos.panos_tag_object:
        provider: "{{ provider }}"
        name: "{{ item }}"
        state: "present"
      notify: panos_commit
      loop: "{{ address_objects|map(attribute='tag')|flatten|unique|default([]) }}"

    - name: Address object(s)
      paloaltonetworks.panos.panos_address_object:
        provider: "{{ provider }}"
        name: "{{ item.name }}"
        address_type: "{{ item.address_type|default('ip-netmask') }}"
        value: "{{ item.value }}"
        description: "{{ item.description|default('Ansible Managed') }}"
        tag: "{{ item.tag|default([]) }}"
        state: "{{ item.state|default('present') }}"
      notify: panos_commit
      loop: "{{ address_objects }}"

    # Create a dynamic address group if addresses share tag names.
    - name: Dynamic address group(s)
      paloaltonetworks.panos.panos_address_group:
        provider: "{{ provider }}"
        name: "{{ item }}"
        dynamic_value: "'{{ item }}'"
        tag: ['{{ item }}']
      notify: panos_commit
      loop: "{{ address_objects|map(attribute='tag')|flatten|community.general.counter|dict2items|rejectattr('value', '<', 2)|map(attribute='key')|list }}"
      when: item|lower != "any"

  when:
    - address_objects is defined
